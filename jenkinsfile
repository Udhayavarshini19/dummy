pipeline {
    agent any

    environment {
        CYPRESS_CACHE_FOLDER = "${WORKSPACE}/.cache/Cypress"
        CYPRESS_REPORTS = "cypress/reports"
    }

    stages {
        stage('Install Dependencies') {
            steps {
                script {
                    if (fileExists('package-lock.json')) {
                        sh 'npm ci'  // Faster installation if lockfile exists
                    } else {
                        sh 'npm install'
                    }
                }
            }
        }

        stage('Run Cypress Tests') {
            steps {
                sh 'npx cypress run'
            }
        }

        stage('Merge Reports') {
            steps {
                sh '''
                npx mochawesome-merge ${CYPRESS_REPORTS}/json/*.json -o ${CYPRESS_REPORTS}/merged-report.json
                npx marge ${CYPRESS_REPORTS}/merged-report.json -o ${CYPRESS_REPORTS}/html
                '''
            }
        }

        stage('Publish Cypress Report') {
            steps {
                publishHTML([
                    reportDir: "${CYPRESS_REPORTS}/html",
                    reportFiles: 'merged-report.html',
                    reportName: 'Cypress Test Report',
                    keepAll: true
                ])
            }
        }
    }
}
